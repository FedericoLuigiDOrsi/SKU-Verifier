<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SKU Verifier — DirtyTag 3.0</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
/* ============================================
   SKU Verifier — DirtyTag 3.0
   Industrial/Utilitarian Design System
   ============================================ */

:root {
  --bg-primary: #0a0a0b;
  --bg-secondary: #111113;
  --bg-tertiary: #18181b;
  --bg-elevated: #1f1f23;
  --text-primary: #fafafa;
  --text-secondary: #a1a1aa;
  --text-muted: #71717a;
  --border-color: #27272a;
  --border-subtle: #1f1f23;
  --status-success: #22c55e;
  --status-success-bg: rgba(34, 197, 94, 0.12);
  --status-warning: #eab308;
  --status-warning-bg: rgba(234, 179, 8, 0.12);
  --status-error: #ef4444;
  --status-error-bg: rgba(239, 68, 68, 0.12);
  --status-info: #3b82f6;
  --status-info-bg: rgba(59, 130, 246, 0.12);
  --status-neutral: #6b7280;
  --status-neutral-bg: rgba(107, 114, 128, 0.12);
  --accent: #f97316;
  --accent-hover: #fb923c;
  --font-sans: 'Space Grotesk', -apple-system, BlinkMacSystemFont, sans-serif;
  --font-mono: 'JetBrains Mono', 'SF Mono', Monaco, Consolas, monospace;
  --space-1: 0.25rem; --space-2: 0.5rem; --space-3: 0.75rem; --space-4: 1rem;
  --space-5: 1.25rem; --space-6: 1.5rem; --space-8: 2rem; --space-10: 2.5rem; --space-12: 3rem;
  --radius-sm: 4px; --radius-md: 6px; --radius-lg: 8px;
  --transition-fast: 150ms ease; --transition-base: 200ms ease;
}

@media (prefers-color-scheme: light) {
  :root {
    --bg-primary: #fafafa; --bg-secondary: #f4f4f5; --bg-tertiary: #e4e4e7; --bg-elevated: #ffffff;
    --text-primary: #18181b; --text-secondary: #52525b; --text-muted: #71717a;
    --border-color: #d4d4d8; --border-subtle: #e4e4e7;
    --status-success-bg: rgba(34, 197, 94, 0.15); --status-warning-bg: rgba(234, 179, 8, 0.15);
    --status-error-bg: rgba(239, 68, 68, 0.15); --status-info-bg: rgba(59, 130, 246, 0.15);
    --status-neutral-bg: rgba(107, 114, 128, 0.15);
  }
}

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html { font-size: 16px; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
body { font-family: var(--font-sans); background: var(--bg-primary); color: var(--text-primary); line-height: 1.5; min-height: 100vh; }
a { color: var(--accent); text-decoration: none; transition: color var(--transition-fast); }
a:hover { color: var(--accent-hover); }
img { max-width: 100%; height: auto; display: block; }

.app { display: flex; flex-direction: column; min-height: 100vh; }

.topbar {
  display: flex; align-items: center; gap: var(--space-4); padding: var(--space-3) var(--space-6);
  background: var(--bg-secondary); border-bottom: 1px solid var(--border-color);
  position: sticky; top: 0; z-index: 100;
}
.topbar__brand { display: flex; align-items: center; gap: var(--space-2); flex-shrink: 0; }
.brand-mark {
  display: flex; align-items: center; justify-content: center; width: 32px; height: 32px;
  background: var(--accent); color: white; font-weight: 700; font-size: 0.875rem;
  border-radius: var(--radius-sm); letter-spacing: -0.5px;
}
.brand-text { font-weight: 600; font-size: 1rem; color: var(--text-primary); letter-spacing: -0.3px; }
.topbar__search { display: flex; gap: var(--space-2); flex: 1; max-width: 480px; }
.search-input {
  flex: 1; padding: var(--space-2) var(--space-3); background: var(--bg-tertiary);
  border: 1px solid var(--border-color); border-radius: var(--radius-md);
  color: var(--text-primary); font-family: var(--font-mono); font-size: 0.875rem;
  transition: border-color var(--transition-fast), box-shadow var(--transition-fast);
}
.search-input::placeholder { color: var(--text-muted); }
.search-input:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.15); }
.topbar__actions { display: flex; align-items: center; gap: var(--space-3); margin-left: auto; }

.status-indicator {
  display: none; align-items: center; gap: var(--space-2); padding: var(--space-1) var(--space-3);
  font-size: 0.75rem; font-weight: 500; border-radius: var(--radius-sm);
}
.status-indicator.loading { display: flex; background: var(--status-info-bg); color: var(--status-info); }
.status-indicator.error { display: flex; background: var(--status-error-bg); color: var(--status-error); }
.status-indicator.success { display: flex; background: var(--status-success-bg); color: var(--status-success); }

.btn {
  display: inline-flex; align-items: center; justify-content: center; gap: var(--space-2);
  padding: var(--space-2) var(--space-4); font-family: var(--font-sans); font-size: 0.875rem;
  font-weight: 500; border: 1px solid transparent; border-radius: var(--radius-md);
  cursor: pointer; transition: all var(--transition-fast); white-space: nowrap;
}
.btn:disabled { opacity: 0.5; cursor: not-allowed; }
.btn--primary { background: var(--accent); color: white; border-color: var(--accent); }
.btn--primary:hover:not(:disabled) { background: var(--accent-hover); border-color: var(--accent-hover); }
.btn--secondary { background: var(--bg-tertiary); color: var(--text-primary); border-color: var(--border-color); }
.btn--secondary:hover:not(:disabled) { background: var(--bg-elevated); border-color: var(--text-muted); }
.btn--danger { background: transparent; color: var(--status-error); border-color: var(--status-error); }
.btn--danger:hover:not(:disabled) { background: var(--status-error-bg); }
.btn--icon { padding: var(--space-2); background: transparent; color: var(--text-secondary); border-color: transparent; }
.btn--icon:hover:not(:disabled) { color: var(--text-primary); background: var(--bg-tertiary); }
.btn--sm { padding: var(--space-1) var(--space-3); font-size: 0.75rem; }
.icon { width: 18px; height: 18px; flex-shrink: 0; }

.main { flex: 1; padding: var(--space-6); max-width: 1200px; margin: 0 auto; width: 100%; }
.hidden { display: none !important; }

.empty-state {
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  text-align: center; padding: var(--space-12) var(--space-6); color: var(--text-muted);
}
.empty-state__icon { width: 64px; height: 64px; margin-bottom: var(--space-4); opacity: 0.4; }
.empty-state__icon svg { width: 100%; height: 100%; }
.empty-state h2 { font-size: 1.25rem; font-weight: 600; color: var(--text-secondary); margin-bottom: var(--space-2); }
.empty-state p { font-size: 0.875rem; }

.loading-state {
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  padding: var(--space-12) var(--space-6); color: var(--text-muted);
}
.spinner {
  width: 32px; height: 32px; border: 3px solid var(--border-color); border-top-color: var(--accent);
  border-radius: 50%; animation: spin 0.8s linear infinite; margin-bottom: var(--space-4);
}
@keyframes spin { to { transform: rotate(360deg); } }

.error-state {
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  text-align: center; padding: var(--space-12) var(--space-6);
}
.error-state__icon { width: 48px; height: 48px; color: var(--status-error); margin-bottom: var(--space-4); }
.error-state__icon svg { width: 100%; height: 100%; }
.error-state h3 { color: var(--status-error); font-size: 1.125rem; margin-bottom: var(--space-2); }
.error-state p { color: var(--text-secondary); font-size: 0.875rem; }

.card {
  background: var(--bg-secondary); border: 1px solid var(--border-color);
  border-radius: var(--radius-lg); margin-bottom: var(--space-6); overflow: hidden;
}
.card__header {
  display: flex; align-items: center; justify-content: space-between; gap: var(--space-4);
  padding: var(--space-4) var(--space-5); border-bottom: 1px solid var(--border-subtle);
}
.card__header h2, .card__header h3 {
  display: flex; align-items: center; gap: var(--space-2); font-size: 0.875rem; font-weight: 600;
  color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px;
}
.card__header .icon { width: 16px; height: 16px; opacity: 0.7; }
.card__body { padding: var(--space-5); }

.product-sku { font-family: var(--font-mono); font-size: 1.5rem; font-weight: 700; color: var(--text-primary); letter-spacing: -0.5px; }
.status-badges { display: flex; flex-wrap: wrap; gap: var(--space-2); }
.badge {
  display: inline-flex; align-items: center; gap: var(--space-1); padding: var(--space-1) var(--space-2);
  font-size: 0.6875rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.3px; border-radius: var(--radius-sm);
}
.badge--success { background: var(--status-success-bg); color: var(--status-success); }
.badge--warning { background: var(--status-warning-bg); color: var(--status-warning); }
.badge--error { background: var(--status-error-bg); color: var(--status-error); }
.badge--info { background: var(--status-info-bg); color: var(--status-info); }
.badge--neutral { background: var(--status-neutral-bg); color: var(--status-neutral); }

.metadata-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: var(--space-4); margin-bottom: var(--space-5); }
.metadata-item { display: flex; flex-direction: column; gap: var(--space-1); }
.metadata-item__label { font-size: 0.6875rem; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; }
.metadata-item__value { font-size: 0.9375rem; color: var(--text-primary); }
.metadata-item__value.empty { color: var(--text-muted); font-style: italic; }
.color-tags { display: flex; flex-wrap: wrap; gap: var(--space-1); }
.color-tag { padding: var(--space-1) var(--space-2); background: var(--bg-tertiary); border-radius: var(--radius-sm); font-size: 0.75rem; color: var(--text-secondary); }

.notes-section { margin-bottom: var(--space-5); padding: var(--space-4); background: var(--bg-tertiary); border-radius: var(--radius-md); }
.notes-section h4 { font-size: 0.75rem; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: var(--space-2); }
.notes-content { font-size: 0.875rem; color: var(--text-secondary); line-height: 1.6; white-space: pre-wrap; }
.notes-content.truncated { max-height: 100px; overflow: hidden; position: relative; }
.notes-content.truncated::after { content: ''; position: absolute; bottom: 0; left: 0; right: 0; height: 40px; background: linear-gradient(transparent, var(--bg-tertiary)); }
.notes-toggle { margin-top: var(--space-2); font-size: 0.75rem; cursor: pointer; }
.links-section { display: flex; gap: var(--space-3); }

.photo-count { font-size: 0.75rem; color: var(--text-muted); font-weight: 500; }
.photos-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: var(--space-3); }
.photo-tile { background: var(--bg-tertiary); border: 1px solid var(--border-subtle); border-radius: var(--radius-md); overflow: hidden; transition: border-color var(--transition-fast); }
.photo-tile:hover { border-color: var(--border-color); }
.photo-tile__preview { aspect-ratio: 1; background: var(--bg-primary); display: flex; align-items: center; justify-content: center; overflow: hidden; }
.photo-tile__preview img { width: 100%; height: 100%; object-fit: cover; }
.photo-tile__preview .placeholder { color: var(--text-muted); font-size: 0.75rem; }
.photo-tile__info { padding: var(--space-2); border-top: 1px solid var(--border-subtle); }
.photo-tile__name { font-size: 0.6875rem; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: var(--space-1); }
.photo-tile__id { font-family: var(--font-mono); font-size: 0.625rem; color: var(--text-muted); cursor: pointer; display: flex; align-items: center; gap: var(--space-1); }
.photo-tile__id:hover { color: var(--text-secondary); }
.photo-tile__id .icon { width: 12px; height: 12px; opacity: 0; transition: opacity var(--transition-fast); }
.photo-tile__id:hover .icon { opacity: 1; }

.folder-fallback { padding: var(--space-4); }
.warning-box { display: flex; gap: var(--space-3); padding: var(--space-4); border-radius: var(--radius-md); }
.warning-box .icon { flex-shrink: 0; margin-top: 2px; }
.warning-box--info { background: var(--status-info-bg); color: var(--status-info); }
.warning-box--warning { background: var(--status-warning-bg); color: var(--status-warning); }
.warning-box--error { background: var(--status-error-bg); color: var(--status-error); }
.warning-box strong { display: block; font-size: 0.875rem; margin-bottom: var(--space-1); }
.warning-box p { font-size: 0.8125rem; opacity: 0.9; }

.validation-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--space-4); }
@media (max-width: 640px) { .validation-grid { grid-template-columns: 1fr; } }
.validation-card { background: var(--bg-tertiary); border: 1px solid var(--border-subtle); border-radius: var(--radius-md); overflow: hidden; }
.validation-card__header { display: flex; align-items: center; justify-content: space-between; padding: var(--space-3) var(--space-4); border-bottom: 1px solid var(--border-subtle); }
.validation-card__label { font-size: 0.75rem; font-weight: 700; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 1px; }
.validation-status { display: flex; align-items: center; gap: var(--space-1); font-size: 0.6875rem; font-weight: 600; }
.validation-status--verified { color: var(--status-success); }
.validation-status--missing { color: var(--status-warning); }
.validation-status--error { color: var(--status-error); }
.validation-status--unknown { color: var(--text-muted); }
.validation-card__preview { aspect-ratio: 4/3; background: var(--bg-primary); display: flex; align-items: center; justify-content: center; overflow: hidden; }
.validation-card__preview img { width: 100%; height: 100%; object-fit: contain; }
.validation-card__preview .placeholder { color: var(--text-muted); font-size: 0.8125rem; }
.validation-card__info { display: flex; align-items: center; justify-content: space-between; gap: var(--space-3); padding: var(--space-3) var(--space-4); border-top: 1px solid var(--border-subtle); }
.fileid { font-family: var(--font-mono); font-size: 0.6875rem; color: var(--text-muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 160px; cursor: pointer; }
.fileid:hover { color: var(--text-secondary); }

.ai-images-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--space-4); }
@media (max-width: 640px) { .ai-images-grid { grid-template-columns: 1fr; } }
.ai-image-card { background: var(--bg-tertiary); border: 1px solid var(--border-subtle); border-radius: var(--radius-md); overflow: hidden; }
.ai-image-label { display: block; padding: var(--space-2) var(--space-3); font-size: 0.6875rem; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 1px solid var(--border-subtle); }
.ai-image-preview { aspect-ratio: 3/4; background: var(--bg-primary); display: flex; align-items: center; justify-content: center; }
.ai-image-preview img { width: 100%; height: 100%; object-fit: contain; }
.ai-image-preview .placeholder { color: var(--text-muted); font-size: 0.8125rem; }

.modal { position: fixed; inset: 0; z-index: 1000; display: flex; align-items: center; justify-content: center; padding: var(--space-4); }
.modal__backdrop { position: absolute; inset: 0; background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(4px); }
.modal__content { position: relative; width: 100%; max-width: 480px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: var(--radius-lg); box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); }
.modal__header { display: flex; align-items: center; justify-content: space-between; padding: var(--space-4) var(--space-5); border-bottom: 1px solid var(--border-subtle); }
.modal__header h3 { font-size: 1rem; font-weight: 600; }
.modal__body { padding: var(--space-5); }
.modal__footer { display: flex; justify-content: space-between; gap: var(--space-3); padding: var(--space-4) var(--space-5); border-top: 1px solid var(--border-subtle); }

.form-group { margin-bottom: var(--space-5); }
.form-group label { display: block; font-size: 0.8125rem; font-weight: 500; color: var(--text-primary); margin-bottom: var(--space-2); }
.form-group .required { color: var(--status-error); }
.form-group .optional { color: var(--text-muted); font-weight: 400; }
.form-group small { display: block; margin-top: var(--space-2); font-size: 0.75rem; color: var(--text-muted); }
.input-group { display: flex; gap: var(--space-2); }
.form-input { flex: 1; padding: var(--space-3); background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: var(--radius-md); color: var(--text-primary); font-family: var(--font-mono); font-size: 0.875rem; }
.form-input::placeholder { color: var(--text-muted); }
.form-input:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.15); }
.info-box { display: flex; align-items: flex-start; gap: var(--space-3); padding: var(--space-3); background: var(--bg-tertiary); border-radius: var(--radius-md); font-size: 0.75rem; color: var(--text-muted); }
.info-box .icon { flex-shrink: 0; width: 16px; height: 16px; opacity: 0.6; }

.icon-eye-off { display: none; }
.showing .icon-eye { display: none; }
.showing .icon-eye-off { display: block; }

.toast {
  position: fixed; bottom: var(--space-6); right: var(--space-6); padding: var(--space-3) var(--space-4);
  background: var(--bg-elevated); border: 1px solid var(--border-color); border-radius: var(--radius-md);
  box-shadow: 0 10px 40px -10px rgba(0, 0, 0, 0.5); font-size: 0.875rem; z-index: 2000; animation: slideIn 0.3s ease;
}
.toast--success { border-color: var(--status-success); color: var(--status-success); }
.toast--error { border-color: var(--status-error); color: var(--status-error); }
@keyframes slideIn { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

@media (max-width: 768px) {
  .topbar { flex-wrap: wrap; padding: var(--space-3); }
  .topbar__search { order: 3; flex: 0 0 100%; max-width: none; margin-top: var(--space-3); }
  .main { padding: var(--space-4); }
  .metadata-grid { grid-template-columns: repeat(2, 1fr); }
  .photos-grid { grid-template-columns: repeat(2, 1fr); }
}
@media (max-width: 480px) {
  .brand-text { display: none; }
  .metadata-grid { grid-template-columns: 1fr; }
}
  </style>
</head>
<body>
  <div class="app">
    <header class="topbar">
      <div class="topbar__brand">
        <span class="brand-mark">DT</span>
        <span class="brand-text">SKU Verifier</span>
      </div>
      <div class="topbar__search">
        <input type="text" id="sku-input" class="search-input" placeholder="SKU (es. MF-2411)" autocomplete="off" spellcheck="false">
        <button id="search-btn" class="btn btn--primary">
          <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
          <span>Search</span>
        </button>
      </div>
      <div class="topbar__actions">
        <div id="status-indicator" class="status-indicator"></div>
        <button id="settings-btn" class="btn btn--icon" title="Settings">
          <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
        </button>
      </div>
    </header>

    <main class="main">
      <div id="empty-state" class="empty-state">
        <div class="empty-state__icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg></div>
        <h2>Cerca un SKU</h2>
        <p>Inserisci un codice SKU per verificare stato e foto del prodotto</p>
      </div>
      <div id="loading-state" class="loading-state hidden"><div class="spinner"></div><p>Caricamento...</p></div>
      <div id="error-state" class="error-state hidden">
        <div class="error-state__icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 8v4m0 4h.01"/></svg></div>
        <h3 id="error-title">Errore</h3>
        <p id="error-message"></p>
      </div>

      <div id="results-container" class="results hidden">
        <section class="card product-overview">
          <div class="card__header">
            <h2 id="product-sku" class="product-sku">—</h2>
            <div id="status-badges" class="status-badges"></div>
          </div>
          <div class="card__body">
            <div class="metadata-grid" id="metadata-grid"></div>
            <div class="notes-section hidden" id="notes-section"><h4>Note Prodotto</h4><div id="notes-content" class="notes-content"></div></div>
            <div class="links-section" id="links-section">
              <a id="folder-link" href="#" target="_blank" class="btn btn--secondary hidden">
                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>
                Apri Cartella Drive
              </a>
            </div>
          </div>
        </section>

        <section class="card folder-photos">
          <div class="card__header">
            <h3><svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>Foto Cartella RAW</h3>
            <span id="photo-count" class="photo-count"></span>
          </div>
          <div id="folder-content" class="card__body">
            <div id="photos-grid" class="photos-grid"></div>
            <div id="folder-fallback" class="folder-fallback hidden">
              <div class="warning-box warning-box--info">
                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4m0-4h.01"/></svg>
                <div><strong>Listing cartella non disponibile</strong><p>Verifica i contenuti manualmente tramite il link sopra.</p></div>
              </div>
            </div>
          </div>
        </section>

        <section class="card validation-section">
          <div class="card__header">
            <h3><svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>Validazione FRONT / BACK</h3>
          </div>
          <div class="card__body">
            <div class="validation-grid">
              <div class="validation-card" id="front-card">
                <div class="validation-card__header"><span class="validation-card__label">FRONT</span><div id="front-status" class="validation-status"></div></div>
                <div class="validation-card__preview" id="front-preview"><div class="placeholder">Nessun FileID</div></div>
                <div class="validation-card__info"><code id="front-fileid" class="fileid">—</code><a id="front-link" href="#" target="_blank" class="btn btn--sm hidden">Apri</a></div>
              </div>
              <div class="validation-card" id="back-card">
                <div class="validation-card__header"><span class="validation-card__label">BACK</span><div id="back-status" class="validation-status"></div></div>
                <div class="validation-card__preview" id="back-preview"><div class="placeholder">Nessun FileID</div></div>
                <div class="validation-card__info"><code id="back-fileid" class="fileid">—</code><a id="back-link" href="#" target="_blank" class="btn btn--sm hidden">Apri</a></div>
              </div>
            </div>
          </div>
        </section>

        <section class="card ai-images-section hidden" id="ai-images-section">
          <div class="card__header">
            <h3><svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>Immagini AI Generate</h3>
          </div>
          <div class="card__body">
            <div class="ai-images-grid">
              <div class="ai-image-card" id="ai-front-card"><span class="ai-image-label">AI FRONT</span><div class="ai-image-preview" id="ai-front-preview"></div></div>
              <div class="ai-image-card" id="ai-back-card"><span class="ai-image-label">AI BACK</span><div class="ai-image-preview" id="ai-back-preview"></div></div>
            </div>
          </div>
        </section>
      </div>
    </main>

    <div id="settings-modal" class="modal hidden">
      <div class="modal__backdrop"></div>
      <div class="modal__content">
        <div class="modal__header">
          <h3>Impostazioni</h3>
          <button id="modal-close" class="btn btn--icon"><svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg></button>
        </div>
        <div class="modal__body">
          <div class="form-group">
            <label for="airtable-pat">Airtable Personal Access Token <span class="required">*</span></label>
            <div class="input-group">
              <input type="password" id="airtable-pat" class="form-input" placeholder="pat..." autocomplete="off">
              <button type="button" id="toggle-pat" class="btn btn--icon">
                <svg class="icon icon-eye" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
                <svg class="icon icon-eye-off hidden" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/></svg>
              </button>
            </div>
            <small>Richiesto. Crea token su <a href="https://airtable.com/create/tokens" target="_blank">airtable.com/create/tokens</a></small>
          </div>
          <div class="form-group">
            <label for="google-api-key">Google API Key <span class="optional">(opzionale)</span></label>
            <div class="input-group">
              <input type="password" id="google-api-key" class="form-input" placeholder="AIza..." autocomplete="off">
              <button type="button" id="toggle-gapi" class="btn btn--icon">
                <svg class="icon icon-eye" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
                <svg class="icon icon-eye-off hidden" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/></svg>
              </button>
            </div>
            <small>Per listare contenuti cartelle Drive. <a href="https://console.cloud.google.com/apis/credentials" target="_blank">Google Cloud Console</a></small>
          </div>
          <div class="info-box">
            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4m0-4h.01"/></svg>
            <span>I token sono salvati solo in questo browser. Non vengono mai condivisi.</span>
          </div>
        </div>
        <div class="modal__footer">
          <button id="clear-tokens" class="btn btn--danger">Cancella Tutto</button>
          <button id="save-settings" class="btn btn--primary">Salva</button>
        </div>
      </div>
    </div>
  </div>

<script>
// ============================================
// SKU Verifier - Single File App
// DirtyTag 3.0
// ============================================

(function() {
  'use strict';

  // Configuration
  const CONFIG = {
    BASE_ID: 'apptD8GSxN3vhhivI',
    INVENTARIO_TABLE_ID: 'tblddAcLcQAyk050u',
    RAW_TABLE_ID: 'tblUWMOM3HKCCEwu6'
  };

  const INVENTARIO_FIELDS = [
    'SKU', 'Product_Status', 'AI_Status', 'AI_Quality_Check', 'Listing_Status',
    'Brand_TXT', 'Category', 'Sub-Category', 'gender', 'Size (INT)', 'Colors',
    'Condizione', 'Note Prodotto', 'RAW', 'RAW_FolderID', 'RAW_Photo_Count',
    'rawID_FRONT', 'rawID_BACK', 'AI_Front_Image_Link', 'AI_Back_Image_Link'
  ];

  // DOM Elements
  let elements = {};

  // State
  let currentRecord = null;
  let currentFolderId = null;
  let folderFiles = null;

  // ============================================
  // Storage Helpers
  // ============================================
  const getToken = () => localStorage.getItem('dirtytag_airtable_pat');
  const getApiKey = () => localStorage.getItem('dirtytag_google_api_key');

  // ============================================
  // SKU Normalization (no format restriction)
  // ============================================
  function normalizeSKU(input) {
    return input.trim().toUpperCase();
  }

  // ============================================
  // Airtable API
  // ============================================
  async function fetchProductBySKU(skuInput) {
    const sku = normalizeSKU(skuInput);
    const token = getToken();
    
    if (!token) throw new Error('Token Airtable non configurato. Vai su Settings.');

    const params = new URLSearchParams();
    params.append('filterByFormula', `{SKU}='${sku}'`);
    INVENTARIO_FIELDS.forEach(f => params.append('fields[]', f));

    const url = `https://api.airtable.com/v0/${CONFIG.BASE_ID}/${CONFIG.INVENTARIO_TABLE_ID}?${params}`;
    
    const response = await fetch(url, {
      headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' }
    });

    if (!response.ok) {
      if (response.status === 401) throw new Error('Token non valido. Verifica Settings.');
      if (response.status === 429) throw new Error('Rate limit raggiunto. Attendi 30 secondi.');
      throw new Error(`Errore API: ${response.status}`);
    }

    const data = await response.json();
    if (!data.records || data.records.length === 0) {
      throw new Error(`SKU "${sku}" non trovato`);
    }
    return data.records[0];
  }

  async function fetchRawRecord(recordId) {
    const token = getToken();
    const url = `https://api.airtable.com/v0/${CONFIG.BASE_ID}/${CONFIG.RAW_TABLE_ID}/${recordId}`;
    
    try {
      const response = await fetch(url, {
        headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' }
      });
      if (!response.ok) return null;
      return response.json();
    } catch { return null; }
  }

  async function resolveFolderID(record) {
    const fields = record.fields;
    if (fields.RAW_FolderID) {
      return Array.isArray(fields.RAW_FolderID) ? fields.RAW_FolderID[0] : fields.RAW_FolderID;
    }
    const rawLink = fields.RAW;
    if (rawLink && rawLink.length > 0) {
      const rawRecord = await fetchRawRecord(rawLink[0]);
      if (rawRecord?.fields) return rawRecord.fields.Folder_ID || null;
    }
    return null;
  }

  function getStatusBadgeType(status, field) {
    if (!status) return 'neutral';
    const s = status.toUpperCase();
    if (field === 'Product_Status') {
      if (s.includes('ERROR')) return 'error';
      if (s.includes('READY') || s.includes('DONE') || s.includes('GENERATED') || s === 'LISTED' || s === 'SOLD') return 'success';
      if (s.includes('PENDING') || s.includes('PROCESSING') || s.includes('WAITING')) return 'warning';
    }
    if (field === 'AI_Status') {
      if (s.includes('ERROR')) return 'error';
      if (s === 'AI_DONE') return 'success';
      if (s.includes('PENDING') || s.includes('PROCESSING')) return 'warning';
    }
    if (field === 'AI_Quality_Check') {
      if (s === 'APPROVED') return 'success';
      if (s === 'REJECTED') return 'error';
      if (s === 'PENDING') return 'warning';
    }
    if (field === 'Listing_Status') {
      if (s === 'PUBLISHED' || s === 'LIVE') return 'info';
    }
    return 'neutral';
  }

  // ============================================
  // Google Drive Helpers
  // ============================================
  const thumbnailUrl = (fileId, size = 400) => fileId ? `https://drive.google.com/thumbnail?id=${fileId}&sz=w${size}` : null;
  const fileViewUrl = (fileId) => fileId ? `https://drive.google.com/file/d/${fileId}/view` : null;
  const folderUrl = (folderId) => folderId ? `https://drive.google.com/drive/folders/${folderId}` : null;

  async function listDriveFiles(folderId) {
    const apiKey = getApiKey();
    if (!apiKey) throw new Error('API_KEY_MISSING');
    if (!folderId) throw new Error('FOLDER_ID_MISSING');

    const query = `'${folderId}' in parents and mimeType contains 'image' and trashed = false`;
    const params = new URLSearchParams({
      q: query, fields: 'files(id,name,mimeType,thumbnailLink,size)', orderBy: 'name', pageSize: '100', key: apiKey
    });
    
    const response = await fetch(`https://www.googleapis.com/drive/v3/files?${params}`);
    if (!response.ok) {
      if (response.status === 403) throw new Error('ACCESS_DENIED');
      throw new Error('API_ERROR');
    }
    const data = await response.json();
    return data.files || [];
  }

  function verifyFileInFolder(fileId, files) {
    if (!fileId || !files) return null;
    return files.some(f => f.id === fileId);
  }

  // ============================================
  // UI Functions
  // ============================================
  function showState(state) {
    elements.emptyState.classList.add('hidden');
    elements.loadingState.classList.add('hidden');
    elements.errorState.classList.add('hidden');
    elements.resultsContainer.classList.add('hidden');
    
    const el = {
      'empty': elements.emptyState, 'loading': elements.loadingState,
      'error': elements.errorState, 'results': elements.resultsContainer
    }[state];
    if (el) el.classList.remove('hidden');
  }

  function showError(title, message) {
    elements.errorTitle.textContent = title || 'Errore';
    elements.errorMessage.textContent = message || 'Si è verificato un errore.';
    showState('error');
    setStatusIndicator('error', 'Errore');
  }

  function setStatusIndicator(type, text) {
    elements.statusIndicator.className = `status-indicator ${type}`;
    elements.statusIndicator.textContent = text || '';
    if (type === 'success') setTimeout(() => { elements.statusIndicator.className = 'status-indicator'; elements.statusIndicator.textContent = ''; }, 3000);
  }

  function showToast(message, type = 'success') {
    document.querySelectorAll('.toast').forEach(t => t.remove());
    const toast = document.createElement('div');
    toast.className = `toast toast--${type}`;
    toast.textContent = message;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 2000);
  }

  async function copyToClipboard(text) {
    try { await navigator.clipboard.writeText(text); showToast('Copiato!'); }
    catch { showToast('Errore copia', 'error'); }
  }

  function renderStatusBadges(fields) {
    elements.statusBadges.innerHTML = '';
    [{ field: 'Product_Status', label: 'Status' }, { field: 'AI_Status', label: 'AI' },
     { field: 'AI_Quality_Check', label: 'QC' }, { field: 'Listing_Status', label: 'Listing' }
    ].forEach(({ field, label }) => {
      const value = fields[field];
      if (value) {
        const badge = document.createElement('span');
        badge.className = `badge badge--${getStatusBadgeType(value, field)}`;
        badge.innerHTML = `<span>${label}:</span> ${value}`;
        elements.statusBadges.appendChild(badge);
      }
    });
  }

  function renderMetadata(fields) {
    elements.metadataGrid.innerHTML = '';
    [{ key: 'Brand_TXT', label: 'Brand' }, { key: 'Category', label: 'Categoria' },
     { key: 'Sub-Category', label: 'Sub-Categoria' }, { key: 'gender', label: 'Genere' },
     { key: 'Size (INT)', label: 'Taglia' }, { key: 'Colors', label: 'Colori' },
     { key: 'Condizione', label: 'Condizione' }, { key: 'RAW_Photo_Count', label: 'Foto RAW' }
    ].forEach(({ key, label }) => {
      let value = fields[key];
      if (Array.isArray(value) && key !== 'Colors') value = value[0];
      
      const item = document.createElement('div');
      item.className = 'metadata-item';
      item.innerHTML = `<span class="metadata-item__label">${label}</span><span class="metadata-item__value${!value ? ' empty' : ''}"></span>`;
      
      const valueEl = item.querySelector('.metadata-item__value');
      if (!value || (Array.isArray(value) && value.length === 0)) {
        valueEl.textContent = '—';
      } else if (Array.isArray(value)) {
        value.forEach(v => { const tag = document.createElement('span'); tag.className = 'color-tag'; tag.textContent = v; valueEl.appendChild(tag); });
        valueEl.className = 'metadata-item__value color-tags';
      } else {
        valueEl.textContent = value;
      }
      elements.metadataGrid.appendChild(item);
    });
  }

  function renderNotes(notes) {
    if (!notes || notes.trim() === '') { elements.notesSection.classList.add('hidden'); return; }
    elements.notesSection.classList.remove('hidden');
    elements.notesContent.textContent = notes;
  }

  function renderFolderLink(folderId) {
    if (!folderId) { elements.folderLink.classList.add('hidden'); return; }
    elements.folderLink.classList.remove('hidden');
    elements.folderLink.href = folderUrl(folderId);
  }

  function renderPhotosGrid(files) {
    elements.photosGrid.innerHTML = '';
    elements.folderFallback.classList.add('hidden');
    
    if (!files || files.length === 0) {
      elements.photosGrid.innerHTML = '<div class="placeholder">Nessuna immagine nella cartella</div>';
      return;
    }

    files.forEach(file => {
      const tile = document.createElement('div');
      tile.className = 'photo-tile';
      tile.style.cursor = 'pointer';
      tile.innerHTML = `
        <div class="photo-tile__preview"><img src="${thumbnailUrl(file.id, 200)}" alt="${file.name}" loading="lazy" onerror="this.parentElement.innerHTML='<div class=placeholder>⚠️</div>'"></div>
        <div class="photo-tile__info">
          <div class="photo-tile__name" title="${file.name}">${file.name}</div>
          <div class="photo-tile__id">${file.id.substring(0, 12)}...<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg></div>
        </div>`;
      tile.querySelector('.photo-tile__id').onclick = (e) => { e.stopPropagation(); copyToClipboard(file.id); };
      tile.onclick = () => window.open(fileViewUrl(file.id), '_blank');
      elements.photosGrid.appendChild(tile);
    });
    elements.photoCount.textContent = `${files.length} foto`;
  }

  function showFolderFallback(photoCount) {
    elements.photosGrid.innerHTML = '';
    elements.folderFallback.classList.remove('hidden');
    elements.photoCount.textContent = photoCount ? `${photoCount} foto (stimate)` : '';
  }

  function renderValidationCard(type, fileId, files) {
    const isVerified = files ? verifyFileInFolder(fileId, files) : null;
    const statusEl = type === 'front' ? elements.frontStatus : elements.backStatus;
    const previewEl = type === 'front' ? elements.frontPreview : elements.backPreview;
    const fileidEl = type === 'front' ? elements.frontFileid : elements.backFileid;
    const linkEl = type === 'front' ? elements.frontLink : elements.backLink;

    if (!fileId) {
      statusEl.className = 'validation-status validation-status--missing';
      statusEl.innerHTML = '⚠️ Missing';
    } else if (isVerified === true) {
      statusEl.className = 'validation-status validation-status--verified';
      statusEl.innerHTML = '✅ Verificato';
    } else if (isVerified === false) {
      statusEl.className = 'validation-status validation-status--error';
      statusEl.innerHTML = '❌ Non trovato';
    } else {
      statusEl.className = 'validation-status validation-status--unknown';
      statusEl.innerHTML = '— Non verificabile';
    }

    if (fileId) {
      previewEl.innerHTML = `<img src="${thumbnailUrl(fileId, 400)}" alt="Preview" loading="lazy" onerror="this.parentElement.innerHTML='<div class=placeholder>Immagine non disponibile</div>'">`;
      fileidEl.textContent = fileId.length > 20 ? fileId.substring(0, 20) + '...' : fileId;
      fileidEl.title = fileId;
      fileidEl.onclick = () => copyToClipboard(fileId);
      linkEl.classList.remove('hidden');
      linkEl.href = fileViewUrl(fileId);
    } else {
      previewEl.innerHTML = '<div class="placeholder">Nessun FileID</div>';
      fileidEl.textContent = '—';
      fileidEl.onclick = null;
      linkEl.classList.add('hidden');
    }
  }

  function renderAIImages(frontUrl, backUrl) {
    const hasFront = frontUrl && frontUrl.trim() !== '';
    const hasBack = backUrl && backUrl.trim() !== '';
    if (!hasFront && !hasBack) { elements.aiImagesSection.classList.add('hidden'); return; }
    
    elements.aiImagesSection.classList.remove('hidden');
    elements.aiFrontPreview.innerHTML = hasFront 
      ? `<img src="${frontUrl}" alt="AI Front" loading="lazy" onerror="this.parentElement.innerHTML='<div class=placeholder>Non disponibile</div>'">`
      : '<div class="placeholder">Non generata</div>';
    elements.aiBackPreview.innerHTML = hasBack
      ? `<img src="${backUrl}" alt="AI Back" loading="lazy" onerror="this.parentElement.innerHTML='<div class=placeholder>Non disponibile</div>'">`
      : '<div class="placeholder">Non generata</div>';
  }

  // ============================================
  // Main Logic
  // ============================================
  async function handleSearch() {
    const skuInput = elements.skuInput.value.trim();
    if (!skuInput) { showToast('Inserisci un SKU', 'error'); elements.skuInput.focus(); return; }
    if (!getToken()) { openModal(); showToast('Configura prima il token Airtable', 'error'); return; }

    currentRecord = null; currentFolderId = null; folderFiles = null;
    showState('loading');
    setStatusIndicator('loading', 'Caricamento...');
    elements.searchBtn.disabled = true;

    try {
      const record = await fetchProductBySKU(skuInput);
      currentRecord = record;
      updateURL(record.fields.SKU);
      renderProduct(record);
      currentFolderId = await resolveFolderID(record);
      renderFolderLink(currentFolderId);
      
      if (currentFolderId) {
        await loadFolderContents(currentFolderId, record.fields.RAW_Photo_Count);
      } else {
        showFolderFallback(null);
        renderValidationCard('front', record.fields.rawID_FRONT, null);
        renderValidationCard('back', record.fields.rawID_BACK, null);
      }
      
      showState('results');
      setStatusIndicator('success', 'Trovato');
    } catch (error) {
      console.error('Search error:', error);
      showError('Errore', error.message);
    } finally {
      elements.searchBtn.disabled = false;
    }
  }

  function renderProduct(record) {
    const fields = record.fields;
    elements.productSku.textContent = fields.SKU || '—';
    renderStatusBadges(fields);
    renderMetadata(fields);
    renderNotes(fields['Note Prodotto']);
    renderAIImages(fields.AI_Front_Image_Link, fields.AI_Back_Image_Link);
  }

  async function loadFolderContents(folderId, estimatedCount) {
    const fields = currentRecord.fields;
    try {
      folderFiles = await listDriveFiles(folderId);
      renderPhotosGrid(folderFiles);
      renderValidationCard('front', fields.rawID_FRONT, folderFiles);
      renderValidationCard('back', fields.rawID_BACK, folderFiles);
    } catch (error) {
      console.warn('Folder listing failed:', error.message);
      showFolderFallback(estimatedCount);
      renderValidationCard('front', fields.rawID_FRONT, null);
      renderValidationCard('back', fields.rawID_BACK, null);
      if (error.message === 'API_KEY_MISSING') showToast('API Key Google mancante per listing cartella', 'error');
      else if (error.message === 'ACCESS_DENIED') showToast('Accesso cartella negato', 'error');
    }
  }

  function updateURL(sku) {
    const url = new URL(window.location);
    url.searchParams.set('sku', sku);
    window.history.replaceState({}, '', url);
  }

  // ============================================
  // Modal Functions
  // ============================================
  function openModal() {
    elements.modal.classList.remove('hidden');
    document.body.style.overflow = 'hidden';
    elements.airtablePat.value = localStorage.getItem('dirtytag_airtable_pat') || '';
    elements.googleApiKey.value = localStorage.getItem('dirtytag_google_api_key') || '';
  }

  function closeModal() {
    elements.modal.classList.add('hidden');
    document.body.style.overflow = '';
  }

  function handleSaveSettings() {
    const airtablePat = elements.airtablePat.value.trim();
    const googleApiKey = elements.googleApiKey.value.trim();
    
    if (!airtablePat) { showToast('Token Airtable richiesto', 'error'); elements.airtablePat.focus(); return; }
    if (!airtablePat.startsWith('pat')) { showToast('Formato token non valido (deve iniziare con "pat")', 'error'); elements.airtablePat.focus(); return; }
    
    localStorage.setItem('dirtytag_airtable_pat', airtablePat);
    if (googleApiKey) localStorage.setItem('dirtytag_google_api_key', googleApiKey);
    else localStorage.removeItem('dirtytag_google_api_key');
    
    closeModal();
    showToast('Impostazioni salvate');
    if (elements.errorTitle.textContent === 'Token Mancante') { showState('empty'); elements.skuInput.focus(); }
  }

  function handleClearTokens() {
    if (!confirm('Vuoi davvero cancellare tutti i token salvati?')) return;
    localStorage.removeItem('dirtytag_airtable_pat');
    localStorage.removeItem('dirtytag_google_api_key');
    elements.airtablePat.value = '';
    elements.googleApiKey.value = '';
    closeModal();
    showToast('Token cancellati');
    checkTokenStatus();
  }

  function togglePasswordVisibility(inputId, buttonId) {
    const input = document.getElementById(inputId);
    const button = document.getElementById(buttonId);
    input.type = input.type === 'password' ? 'text' : 'password';
    button.classList.toggle('showing');
  }

  function checkTokenStatus() {
    if (!getToken()) showError('Token Mancante', 'Configura il token Airtable nelle Impostazioni per iniziare.');
  }

  // ============================================
  // Initialize
  // ============================================
  function init() {
    elements = {
      emptyState: document.getElementById('empty-state'),
      loadingState: document.getElementById('loading-state'),
      errorState: document.getElementById('error-state'),
      resultsContainer: document.getElementById('results-container'),
      skuInput: document.getElementById('sku-input'),
      searchBtn: document.getElementById('search-btn'),
      settingsBtn: document.getElementById('settings-btn'),
      statusIndicator: document.getElementById('status-indicator'),
      productSku: document.getElementById('product-sku'),
      statusBadges: document.getElementById('status-badges'),
      metadataGrid: document.getElementById('metadata-grid'),
      notesSection: document.getElementById('notes-section'),
      notesContent: document.getElementById('notes-content'),
      folderLink: document.getElementById('folder-link'),
      photoCount: document.getElementById('photo-count'),
      photosGrid: document.getElementById('photos-grid'),
      folderFallback: document.getElementById('folder-fallback'),
      frontStatus: document.getElementById('front-status'),
      frontPreview: document.getElementById('front-preview'),
      frontFileid: document.getElementById('front-fileid'),
      frontLink: document.getElementById('front-link'),
      backStatus: document.getElementById('back-status'),
      backPreview: document.getElementById('back-preview'),
      backFileid: document.getElementById('back-fileid'),
      backLink: document.getElementById('back-link'),
      aiImagesSection: document.getElementById('ai-images-section'),
      aiFrontPreview: document.getElementById('ai-front-preview'),
      aiBackPreview: document.getElementById('ai-back-preview'),
      modal: document.getElementById('settings-modal'),
      modalClose: document.getElementById('modal-close'),
      airtablePat: document.getElementById('airtable-pat'),
      googleApiKey: document.getElementById('google-api-key'),
      togglePat: document.getElementById('toggle-pat'),
      toggleGapi: document.getElementById('toggle-gapi'),
      saveSettings: document.getElementById('save-settings'),
      clearTokens: document.getElementById('clear-tokens'),
      errorTitle: document.getElementById('error-title'),
      errorMessage: document.getElementById('error-message')
    };

    // Event listeners
    elements.searchBtn.addEventListener('click', handleSearch);
    elements.skuInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleSearch(); });
    elements.settingsBtn.addEventListener('click', openModal);
    elements.modalClose.addEventListener('click', closeModal);
    elements.modal.querySelector('.modal__backdrop').addEventListener('click', closeModal);
    elements.togglePat.addEventListener('click', () => togglePasswordVisibility('airtable-pat', 'toggle-pat'));
    elements.toggleGapi.addEventListener('click', () => togglePasswordVisibility('google-api-key', 'toggle-gapi'));
    elements.saveSettings.addEventListener('click', handleSaveSettings);
    elements.clearTokens.addEventListener('click', handleClearTokens);
    
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && !elements.modal.classList.contains('hidden')) closeModal();
      if ((e.ctrlKey || e.metaKey) && e.key === 'k') { e.preventDefault(); elements.skuInput.focus(); elements.skuInput.select(); }
    });

    checkTokenStatus();
    elements.skuInput.focus();

    // Auto-search from URL
    const urlParams = new URLSearchParams(window.location.search);
    const skuParam = urlParams.get('sku');
    if (skuParam) { elements.skuInput.value = skuParam; handleSearch(); }
  }

  if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', init);
  else init();
})();
</script>
</body>
</html>
