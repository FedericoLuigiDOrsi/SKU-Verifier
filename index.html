<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DirtyTag ‚Äî Label Verifier</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600;700&family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0a0a0a;
            --bg-secondary: #111111;
            --bg-tertiary: #1a1a1a;
            --bg-elevated: #222222;
            --border: #2a2a2a;
            --border-hover: #3a3a3a;
            --text-primary: #ffffff;
            --text-secondary: #888888;
            --text-muted: #555555;
            --accent-red: #e31e24;
            --accent-red-dim: rgba(227, 30, 36, 0.15);
            --accent-green: #00d26a;
            --accent-green-dim: rgba(0, 210, 106, 0.15);
            --accent-blue: #3b82f6;
            --accent-blue-dim: rgba(59, 130, 246, 0.15);
            --accent-orange: #f59e0b;
            --accent-orange-dim: rgba(245, 158, 11, 0.15);
            --accent-yellow: #eab308;
            --accent-yellow-dim: rgba(234, 179, 8, 0.15);
            --accent-purple: #a855f7;
            --accent-purple-dim: rgba(168, 85, 247, 0.15);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'JetBrains Mono', monospace;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            font-size: 12px;
            line-height: 1.5;
        }

        /* Header */
        .header {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            padding: 12px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 1.1rem;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        .logo span { color: var(--accent-red); }

        .module-badge {
            background: var(--accent-purple-dim);
            border: 1px solid var(--accent-purple);
            color: var(--accent-purple);
            padding: 4px 10px;
            font-size: 0.65rem;
            font-weight: 600;
            letter-spacing: 1px;
            text-transform: uppercase;
        }

        .search-box {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .search-input {
            background: var(--bg-primary);
            border: 1px solid var(--border);
            padding: 8px 14px;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 0.9rem;
            width: 200px;
            transition: border-color 0.2s;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--accent-purple);
        }

        .search-input::placeholder {
            color: var(--text-muted);
        }

        .btn-search {
            background: var(--accent-purple);
            border: none;
            padding: 8px 16px;
            color: white;
            font-family: inherit;
            font-size: 0.75rem;
            font-weight: 600;
            letter-spacing: 1px;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-search:hover {
            background: #9333ea;
        }

        .btn-search:disabled {
            background: var(--bg-tertiary);
            cursor: not-allowed;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .stats-row {
            display: flex;
            gap: 20px;
        }

        .stat-item {
            text-align: center;
            min-width: 70px;
        }

        .stat-value {
            font-size: 1.1rem;
            font-weight: 700;
        }

        .stat-value.green { color: var(--accent-green); }
        .stat-value.red { color: var(--accent-red); }
        .stat-value.yellow { color: var(--accent-yellow); }
        .stat-value.blue { color: var(--accent-blue); }

        .stat-label {
            font-size: 0.55rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn-refresh {
            background: transparent;
            border: 1px solid var(--border);
            padding: 8px 12px;
            color: var(--text-secondary);
            font-family: inherit;
            font-size: 0.7rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-refresh:hover {
            border-color: var(--border-hover);
            color: var(--text-primary);
        }

        .btn-settings {
            background: transparent;
            border: 1px solid var(--border);
            padding: 8px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-settings:hover {
            border-color: var(--border-hover);
            color: var(--text-primary);
        }

        /* Login Panel */
        .login-panel {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: calc(100vh - 60px);
            padding: 40px;
        }

        .login-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            padding: 40px;
            width: 100%;
            max-width: 400px;
        }

        .login-title {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .login-subtitle {
            color: var(--text-secondary);
            font-size: 0.8rem;
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-size: 0.7rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }

        .form-input {
            width: 100%;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            padding: 12px 14px;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 0.85rem;
            transition: border-color 0.2s;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--accent-purple);
        }

        .btn-primary {
            width: 100%;
            background: var(--accent-purple);
            border: none;
            padding: 14px 24px;
            color: white;
            font-family: inherit;
            font-size: 0.8rem;
            font-weight: 600;
            letter-spacing: 1px;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary:hover {
            background: #9333ea;
        }

        /* Main App */
        .main-app {
            display: none;
            min-height: calc(100vh - 60px);
        }

        .app-container {
            display: grid;
            grid-template-columns: 1fr 380px;
            min-height: calc(100vh - 60px);
        }

        /* Photo Section */
        .photo-section {
            padding: 24px;
            overflow-y: auto;
        }

        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 80px 40px;
            text-align: center;
        }

        .empty-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .empty-title {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-secondary);
        }

        .empty-text {
            color: var(--text-muted);
            font-size: 0.85rem;
        }

        /* Photo Grid */
        .photo-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            margin-bottom: 24px;
        }

        .photo-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            overflow: hidden;
        }

        .photo-card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
            background: var(--bg-tertiary);
        }

        .photo-card-title {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .photo-card-title.front { color: var(--accent-red); }
        .photo-card-title.back { color: var(--accent-blue); }

        .photo-container {
            position: relative;
            width: 100%;
            padding-top: 125%;
            background: var(--bg-primary);
            cursor: pointer;
            overflow: hidden;
        }

        .photo-container img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: contain;
            transition: transform 0.3s;
        }

        .photo-container:hover img {
            transform: scale(1.02);
        }

        .photo-placeholder {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
            font-size: 0.75rem;
        }

        /* Action Buttons under photos */
        .action-buttons {
            display: flex;
            gap: 12px;
            padding: 20px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            margin-bottom: 24px;
        }

        .action-btn {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 16px 20px;
            font-family: inherit;
            font-size: 0.75rem;
            font-weight: 600;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid;
            background: transparent;
        }

        .action-btn.label-done {
            border-color: var(--accent-green);
            color: var(--accent-green);
        }

        .action-btn.label-done:hover,
        .action-btn.label-done.active {
            background: var(--accent-green);
            color: white;
        }

        .action-btn.to-check {
            border-color: var(--accent-yellow);
            color: var(--accent-yellow);
        }

        .action-btn.to-check:hover,
        .action-btn.to-check.active {
            background: var(--accent-yellow);
            color: black;
        }

        .action-btn.discard {
            border-color: var(--accent-red);
            color: var(--accent-red);
        }

        .action-btn.discard:hover,
        .action-btn.discard.active {
            background: var(--accent-red);
            color: white;
        }

        .checkbox-indicator {
            width: 20px;
            height: 20px;
            border: 2px solid currentColor;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: 700;
        }

        .action-btn.active .checkbox-indicator {
            background: white;
            color: inherit;
        }

        .action-btn.label-done.active .checkbox-indicator {
            color: var(--accent-green);
        }

        .action-btn.to-check.active .checkbox-indicator {
            color: var(--accent-yellow);
        }

        .action-btn.discard.active .checkbox-indicator {
            color: var(--accent-red);
        }

        /* Controls Panel */
        .controls-panel {
            background: var(--bg-secondary);
            border-left: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        .controls-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
            background: var(--bg-tertiary);
        }

        .controls-title {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .controls-subtitle {
            font-size: 0.7rem;
            color: var(--text-muted);
        }

        .sku-display {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 12px;
        }

        .sku-label {
            color: var(--text-muted);
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .sku-value {
            background: var(--bg-primary);
            border: 1px solid var(--border);
            padding: 6px 14px;
            font-size: 1rem;
            font-weight: 700;
            letter-spacing: 1px;
            color: var(--accent-purple);
        }

        .controls-body {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .control-section {
            margin-bottom: 20px;
        }

        .control-label {
            font-size: 0.65rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .edit-toggle {
            font-size: 0.6rem;
            color: var(--accent-purple);
            cursor: pointer;
            padding: 2px 8px;
            border: 1px solid var(--accent-purple);
            background: transparent;
            transition: all 0.2s;
        }

        .edit-toggle:hover {
            background: var(--accent-purple-dim);
        }

        .edit-toggle.active {
            background: var(--accent-purple);
            color: white;
        }

        /* Info Grid */
        .info-grid {
            display: grid;
            gap: 8px;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 12px;
            background: var(--bg-primary);
            border: 1px solid var(--border);
        }

        .info-key {
            color: var(--text-muted);
            font-size: 0.7rem;
        }

        .info-value {
            color: var(--text-primary);
            font-size: 0.8rem;
            font-weight: 500;
            text-align: right;
        }

        .info-value.empty {
            color: var(--text-muted);
            font-style: italic;
        }

        /* Editable Fields */
        .editable-field {
            width: 100%;
            padding: 10px 12px;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            margin-bottom: 8px;
        }

        .editable-field label {
            display: block;
            font-size: 0.65rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 6px;
        }

        .editable-field input,
        .editable-field select {
            width: 100%;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            padding: 8px 10px;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 0.8rem;
            transition: border-color 0.2s;
        }

        .editable-field input:focus,
        .editable-field select:focus {
            outline: none;
            border-color: var(--accent-purple);
        }

        .editable-field select {
            cursor: pointer;
        }

        /* Color Input */
        .color-input-group {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .color-preview {
            width: 32px;
            height: 32px;
            border: 1px solid var(--border);
            cursor: pointer;
        }

        .color-text {
            flex: 1;
        }

        /* Notes Section */
        .notes-section {
            margin-top: 16px;
        }

        .notes-textarea {
            width: 100%;
            min-height: 100px;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            padding: 12px;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 0.8rem;
            resize: vertical;
            transition: border-color 0.2s;
        }

        .notes-textarea:focus {
            outline: none;
            border-color: var(--accent-purple);
        }

        .notes-textarea::placeholder {
            color: var(--text-muted);
        }

        /* Footer Actions */
        .controls-footer {
            padding: 20px;
            border-top: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .btn-save {
            width: 100%;
            background: var(--accent-purple);
            border: none;
            padding: 16px 24px;
            color: white;
            font-family: inherit;
            font-size: 0.8rem;
            font-weight: 600;
            letter-spacing: 1px;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-save:hover {
            background: #9333ea;
        }

        .btn-save:disabled {
            background: var(--bg-tertiary);
            color: var(--text-muted);
            cursor: not-allowed;
        }

        .btn-next {
            width: 100%;
            background: transparent;
            border: 1px solid var(--border);
            padding: 12px 24px;
            color: var(--text-secondary);
            font-family: inherit;
            font-size: 0.7rem;
            font-weight: 500;
            letter-spacing: 1px;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-next:hover {
            border-color: var(--border-hover);
            color: var(--text-primary);
        }

        /* Keyboard Hints */
        .keyboard-hints {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            padding: 12px 20px;
            border-top: 1px solid var(--border);
            background: var(--bg-primary);
        }

        .hint {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.6rem;
            color: var(--text-muted);
        }

        .hint kbd {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            padding: 2px 6px;
            font-family: inherit;
        }

        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
            cursor: pointer;
        }

        .modal.active {
            opacity: 1;
            visibility: visible;
        }

        .modal img {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
        }

        .modal-close {
            position: absolute;
            top: 20px;
            right: 30px;
            font-size: 2rem;
            color: white;
            cursor: pointer;
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            padding: 14px 28px;
            font-size: 0.8rem;
            opacity: 0;
            transition: all 0.3s;
            z-index: 1001;
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        .toast.success { border-color: var(--accent-green); color: var(--accent-green); }
        .toast.error { border-color: var(--accent-red); color: var(--accent-red); }
        .toast.info { border-color: var(--accent-blue); color: var(--accent-blue); }
        .toast.warning { border-color: var(--accent-yellow); color: var(--accent-yellow); }

        /* Loading */
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px;
            gap: 16px;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border);
            border-top-color: var(--accent-purple);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        .loading-text {
            color: var(--text-muted);
            font-size: 0.75rem;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-left">
            <div class="logo-section">
                <div class="logo">DIRTY<span>TAG</span></div>
                <div class="module-badge">Label Verifier</div>
            </div>
            <div class="search-box" id="search-box" style="display: none;">
                <input type="text" class="search-input" id="sku-search" placeholder="Cerca SKU...">
                <button class="btn-search" id="btn-search">Cerca</button>
            </div>
        </div>
        <div class="header-right" id="header-stats" style="display: none;">
            <div class="stats-row">
                <div class="stat-item">
                    <div class="stat-value green" id="stat-tagged">-</div>
                    <div class="stat-label">Etichettati</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value yellow" id="stat-tocheck">-</div>
                    <div class="stat-label">Da Rivedere</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value blue" id="stat-remaining">-</div>
                    <div class="stat-label">Da Verificare</div>
                </div>
            </div>
            <button class="btn-refresh" id="btn-refresh" title="Aggiorna contatori">‚Üª Refresh</button>
            <button class="btn-settings" id="btn-settings" title="Impostazioni">‚öô</button>
        </div>
    </header>

    <!-- Login Panel -->
    <div class="login-panel" id="login-panel">
        <div class="login-card">
            <h1 class="login-title">Label Verifier</h1>
            <p class="login-subtitle">Verifica articoli e applicazione label</p>
            
            <div class="form-group">
                <label class="form-label">Airtable API Key</label>
                <input type="password" class="form-input" id="api-key" placeholder="pat...">
            </div>
            
            <button class="btn-primary" id="btn-start">Avvia</button>
        </div>
    </div>

    <!-- Main App -->
    <div class="main-app" id="main-app">
        <div class="app-container">
            <!-- Photo Section -->
            <div class="photo-section" id="photo-section">
                <div class="empty-state" id="empty-state">
                    <div class="empty-icon">üîç</div>
                    <h2 class="empty-title">Cerca un articolo</h2>
                    <p class="empty-text">Inserisci lo SKU nella barra di ricerca per verificare l'articolo</p>
                </div>
            </div>

            <!-- Controls Panel -->
            <div class="controls-panel">
                <div class="controls-header">
                    <div class="controls-title">Dettagli Articolo</div>
                    <div class="controls-subtitle">Verifica e modifica informazioni</div>
                    <div class="sku-display" id="sku-display" style="display: none;">
                        <span class="sku-label">SKU</span>
                        <span class="sku-value" id="current-sku">‚Äî</span>
                    </div>
                </div>

                <div class="controls-body" id="controls-body">
                    <!-- Product Info (Read-only mode) -->
                    <div id="info-readonly">
                        <div class="control-section">
                            <div class="control-label">
                                Informazioni Prodotto
                                <button class="edit-toggle" id="edit-toggle">Modifica</button>
                            </div>
                            <div class="info-grid" id="product-info">
                                <div class="info-row">
                                    <span class="info-key">Categoria</span>
                                    <span class="info-value" id="info-category">‚Äî</span>
                                </div>
                                <div class="info-row">
                                    <span class="info-key">Sub-Categoria</span>
                                    <span class="info-value" id="info-subcategory">‚Äî</span>
                                </div>
                                <div class="info-row">
                                    <span class="info-key">Brand</span>
                                    <span class="info-value" id="info-brand">‚Äî</span>
                                </div>
                                <div class="info-row">
                                    <span class="info-key">Colore</span>
                                    <span class="info-value" id="info-color">‚Äî</span>
                                </div>
                                <div class="info-row">
                                    <span class="info-key">Taglia</span>
                                    <span class="info-value" id="info-size">‚Äî</span>
                                </div>
                                <div class="info-row">
                                    <span class="info-key">Genere</span>
                                    <span class="info-value" id="info-gender">‚Äî</span>
                                </div>
                                <div class="info-row">
                                    <span class="info-key">Condizione</span>
                                    <span class="info-value" id="info-condition">‚Äî</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Editable Fields (Edit mode) -->
                    <div id="info-editable" style="display: none;">
                        <div class="control-section">
                            <div class="control-label">
                                Modifica Dettagli
                                <button class="edit-toggle active" id="edit-close">Chiudi</button>
                            </div>
                            
                            <div class="editable-field">
                                <label>Categoria</label>
                                <input type="text" id="edit-category" placeholder="Categoria...">
                            </div>
                            
                            <div class="editable-field">
                                <label>Sub-Categoria</label>
                                <input type="text" id="edit-subcategory" placeholder="Sub-categoria...">
                            </div>
                            
                            <div class="editable-field">
                                <label>Brand</label>
                                <input type="text" id="edit-brand" placeholder="Brand...">
                            </div>
                            
                            <div class="editable-field">
                                <label>Colore</label>
                                <div class="color-input-group">
                                    <input type="color" id="edit-color-picker" class="color-preview" value="#ffffff">
                                    <input type="text" id="edit-color" class="color-text" placeholder="Es. Rosso, Blu...">
                                </div>
                            </div>
                            
                            <div class="editable-field">
                                <label>Taglia</label>
                                <input type="text" id="edit-size" placeholder="Es. M, L, 42...">
                            </div>
                            
                            <div class="editable-field">
                                <label>Genere</label>
                                <select id="edit-gender">
                                    <option value="">Seleziona...</option>
                                    <option value="M">Uomo</option>
                                    <option value="F">Donna</option>
                                    <option value="U">Unisex</option>
                                </select>
                            </div>
                            
                            <div class="editable-field">
                                <label>Condizione</label>
                                <select id="edit-condition">
                                    <option value="">Seleziona...</option>
                                    <option value="Nuovo con etichette">Nuovo con etichette</option>
                                    <option value="Nuovo senza etichette">Nuovo senza etichette</option>
                                    <option value="Ottime condizioni">Ottime condizioni</option>
                                    <option value="Buone condizioni">Buone condizioni</option>
                                    <option value="Usato">Usato</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Notes Section -->
                    <div class="notes-section">
                        <div class="control-label">Note Dettagli</div>
                        <textarea class="notes-textarea" id="notes-input" placeholder="Inserisci note su macchie, difetti, errori database..."></textarea>
                    </div>
                </div>

                <div class="controls-footer">
                    <button class="btn-save" id="btn-save" disabled>
                        üíæ Salva Modifiche
                    </button>
                    <button class="btn-next" id="btn-clear">
                        Nuova Ricerca ‚Üí
                    </button>
                </div>

                <div class="keyboard-hints">
                    <div class="hint"><kbd>T</kbd> Tagged</div>
                    <div class="hint"><kbd>C</kbd> To Check</div>
                    <div class="hint"><kbd>X</kbd> Scarta</div>
                    <div class="hint"><kbd>S</kbd> Salva</div>
                    <div class="hint"><kbd>E</kbd> Modifica</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div class="modal" id="modal">
        <span class="modal-close">√ó</span>
        <img id="modal-img" src="" alt="Full size">
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <script>
        // Configuration
        const BASE_ID = 'apptD8GSxN3vhhivI';
        const INVENTARIO_TABLE = 'tblddAcLcQAyk050u';
        
        let API_KEY = '';
        let currentRecord = null;
        let currentAction = null; // 'tagged', 'tocheck', 'discard'
        let editMode = false;
        let hasChanges = false;
        
        let stats = {
            tagged: 0,
            tocheck: 0,
            remaining: 0
        };

        // ============================================
        // INIT
        // ============================================
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, initializing...');
            
            const savedKey = localStorage.getItem('dirtytag_api_key_v3');
            if (savedKey) {
                document.getElementById('api-key').value = savedKey;
            }

            // Bind event listeners
            document.getElementById('btn-start').addEventListener('click', startApp);
            document.getElementById('btn-search').addEventListener('click', function() {
                console.log('Search button clicked');
                searchSKU();
            });
            document.getElementById('sku-search').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    console.log('Enter pressed in search');
                    searchSKU();
                }
            });
            document.getElementById('btn-refresh').addEventListener('click', loadCounters);
            document.getElementById('btn-settings').addEventListener('click', openSettings);
            document.getElementById('edit-toggle').addEventListener('click', toggleEditMode);
            document.getElementById('edit-close').addEventListener('click', toggleEditMode);
            document.getElementById('btn-save').addEventListener('click', saveChanges);
            document.getElementById('btn-clear').addEventListener('click', clearSearch);
            document.getElementById('modal').addEventListener('click', closeModal);
            
            // API key enter
            document.getElementById('api-key').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') startApp();
            });
        });

        // ============================================
        // APP START
        // ============================================
        function startApp() {
            const key = document.getElementById('api-key').value.trim();
            if (!key) {
                showToast('Inserisci la chiave API', 'error');
                return;
            }
            API_KEY = key;
            localStorage.setItem('dirtytag_api_key_v3', key);
            
            document.getElementById('login-panel').style.display = 'none';
            document.getElementById('main-app').style.display = 'block';
            document.getElementById('search-box').style.display = 'flex';
            document.getElementById('header-stats').style.display = 'flex';
            
            // Load counters from Airtable
            loadCounters();
            
            document.getElementById('sku-search').focus();
        }

        // ============================================
        // TOAST
        // ============================================
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type} show`;
            setTimeout(() => toast.className = 'toast', 2500);
        }

        // ============================================
        // LOAD COUNTERS FROM AIRTABLE
        // ============================================
        async function loadCounters() {
            console.log('Loading counters...');
            document.getElementById('stat-tagged').textContent = '...';
            document.getElementById('stat-tocheck').textContent = '...';
            document.getElementById('stat-remaining').textContent = '...';

            try {
                // Count Tagged_Checkbox = true
                const taggedCount = await countRecords("{Tagged_Checkbox} = TRUE()");
                stats.tagged = taggedCount;
                document.getElementById('stat-tagged').textContent = taggedCount;

                // Count To_Check = true
                const tocheckCount = await countRecords("{To_Check} = TRUE()");
                stats.tocheck = tocheckCount;
                document.getElementById('stat-tocheck').textContent = tocheckCount;

                // Count remaining: NOT Tagged and NOT To_Check and NOT Discarded
                // Quelli da verificare = quelli senza Tagged_Checkbox e senza Product_Status = DISCARDED
                const remainingCount = await countRecords("AND({Tagged_Checkbox} = FALSE(), OR({Product_Status} = '', {Product_Status} != 'DISCARDED'))");
                stats.remaining = remainingCount;
                document.getElementById('stat-remaining').textContent = remainingCount;

                console.log('Counters loaded:', stats);

            } catch (error) {
                console.error('Error loading counters:', error);
                showToast('Errore caricamento contatori', 'error');
                document.getElementById('stat-tagged').textContent = '?';
                document.getElementById('stat-tocheck').textContent = '?';
                document.getElementById('stat-remaining').textContent = '?';
            }
        }

        async function countRecords(filterFormula) {
            let count = 0;
            let offset = null;
            
            do {
                const params = new URLSearchParams();
                params.append('filterByFormula', filterFormula);
                params.append('fields[]', 'SKU'); // Minimal field to reduce payload
                params.append('pageSize', '100');
                if (offset) params.append('offset', offset);

                const url = `https://api.airtable.com/v0/${BASE_ID}/${INVENTARIO_TABLE}?${params}`;
                
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${API_KEY}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`API Error: ${response.status}`);
                }

                const data = await response.json();
                count += data.records.length;
                offset = data.offset;
            } while (offset);

            return count;
        }

        // ============================================
        // SEARCH SKU
        // ============================================
        async function searchSKU() {
            const skuInput = document.getElementById('sku-search').value.trim().toUpperCase();
            console.log('Searching for:', skuInput);
            
            if (!skuInput) {
                showToast('Inserisci uno SKU', 'error');
                return;
            }

            // Show loading
            document.getElementById('photo-section').innerHTML = `
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <div class="loading-text">Ricerca ${skuInput}...</div>
                </div>
            `;

            try {
                const params = new URLSearchParams();
                params.append('filterByFormula', `{SKU}='${skuInput}'`);

                const url = `https://api.airtable.com/v0/${BASE_ID}/${INVENTARIO_TABLE}?${params}`;
                console.log('Fetching:', url);
                
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${API_KEY}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`API Error: ${response.status}`);
                }

                const data = await response.json();
                console.log('Response:', data);

                if (!data.records || data.records.length === 0) {
                    showEmptyResult(skuInput);
                    return;
                }

                currentRecord = data.records[0];
                renderProduct(currentRecord);

            } catch (error) {
                console.error('Search error:', error);
                showToast(`Errore: ${error.message}`, 'error');
                showEmptyState();
            }
        }

        function showEmptyResult(sku) {
            document.getElementById('photo-section').innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon">‚ùå</div>
                    <h2 class="empty-title">SKU non trovato</h2>
                    <p class="empty-text">"${sku}" non esiste nel database</p>
                </div>
            `;
        }

        function showEmptyState() {
            document.getElementById('photo-section').innerHTML = `
                <div class="empty-state" id="empty-state">
                    <div class="empty-icon">üîç</div>
                    <h2 class="empty-title">Cerca un articolo</h2>
                    <p class="empty-text">Inserisci lo SKU nella barra di ricerca per verificare l'articolo</p>
                </div>
            `;
        }

        // ============================================
        // RENDER PRODUCT
        // ============================================
        function renderProduct(record) {
            const fields = record.fields;
            console.log('Rendering product:', fields.SKU, fields);
            
            // Reset state
            currentAction = null;
            hasChanges = false;
            editMode = false;
            document.getElementById('btn-save').disabled = true;
            document.getElementById('info-readonly').style.display = 'block';
            document.getElementById('info-editable').style.display = 'none';

            // Build photo section
            document.getElementById('photo-section').innerHTML = `
                <div id="product-content">
                    <div class="photo-grid">
                        <div class="photo-card">
                            <div class="photo-card-header">
                                <span class="photo-card-title front">‚óÜ FRONT</span>
                            </div>
                            <div class="photo-container" id="photo-front">
                                ${renderPhoto(fields.AI_Front_Image_Link || fields.rawID_FRONT, 'front')}
                            </div>
                        </div>
                        <div class="photo-card">
                            <div class="photo-card-header">
                                <span class="photo-card-title back">‚óÜ BACK</span>
                            </div>
                            <div class="photo-container" id="photo-back">
                                ${renderPhoto(fields.AI_Back_Image_Link || fields.rawID_BACK, 'back')}
                            </div>
                        </div>
                    </div>

                    <div class="action-buttons">
                        <button class="action-btn label-done" id="btn-tagged">
                            <span class="checkbox-indicator">‚úì</span>
                            <span>Label Inserita</span>
                        </button>
                        <button class="action-btn to-check" id="btn-tocheck">
                            <span class="checkbox-indicator">?</span>
                            <span>Da Rivedere</span>
                        </button>
                        <button class="action-btn discard" id="btn-discard">
                            <span class="checkbox-indicator">‚úï</span>
                            <span>Da Scartare</span>
                        </button>
                    </div>
                </div>
            `;

            // Bind action button events
            document.getElementById('btn-tagged').addEventListener('click', () => toggleAction('tagged'));
            document.getElementById('btn-tocheck').addEventListener('click', () => toggleAction('tocheck'));
            document.getElementById('btn-discard').addEventListener('click', () => toggleAction('discard'));
            
            // Bind photo click for modal
            document.getElementById('photo-front').addEventListener('click', () => openModalPhoto('front'));
            document.getElementById('photo-back').addEventListener('click', () => openModalPhoto('back'));

            // Update SKU display
            document.getElementById('sku-display').style.display = 'flex';
            document.getElementById('current-sku').textContent = fields.SKU || '‚Äî';

            // Update info fields
            document.getElementById('info-category').textContent = fields.Category || '‚Äî';
            document.getElementById('info-subcategory').textContent = fields['Sub-Category'] || '‚Äî';
            document.getElementById('info-brand').textContent = fields.Brand_TXT || fields.Brand || '‚Äî';
            document.getElementById('info-color').textContent = formatColors(fields.Colors) || '‚Äî';
            document.getElementById('info-size').textContent = fields['Size (INT)'] || '‚Äî';
            document.getElementById('info-gender').textContent = formatGender(fields.gender) || '‚Äî';
            document.getElementById('info-condition').textContent = fields.Condizione || '‚Äî';

            // Populate editable fields
            document.getElementById('edit-category').value = fields.Category || '';
            document.getElementById('edit-subcategory').value = fields['Sub-Category'] || '';
            document.getElementById('edit-brand').value = fields.Brand_TXT || fields.Brand || '';
            document.getElementById('edit-color').value = formatColors(fields.Colors) || '';
            document.getElementById('edit-size').value = fields['Size (INT)'] || '';
            document.getElementById('edit-gender').value = fields.gender || '';
            document.getElementById('edit-condition').value = fields.Condizione || '';

            // Notes
            document.getElementById('notes-input').value = fields['Note Prodotto'] || '';

            // Check existing status from Airtable
            if (fields.Tagged_Checkbox === true) {
                toggleAction('tagged', true);
            } else if (fields.To_Check === true) {
                toggleAction('tocheck', true);
            } else if (fields.Product_Status === 'DISCARDED') {
                toggleAction('discard', true);
            }
        }

        function renderPhoto(urlOrId, type) {
            if (!urlOrId) {
                return `<div class="photo-placeholder">Nessuna foto ${type}</div>`;
            }
            
            let imgUrl = urlOrId;
            
            // If it's a Drive file ID
            if (!urlOrId.startsWith('http')) {
                imgUrl = `https://drive.google.com/thumbnail?id=${urlOrId}&sz=w600`;
            } else {
                // Extract file ID from Drive URL
                const match = urlOrId.match(/\/d\/([^\/]+)/);
                if (match) {
                    imgUrl = `https://drive.google.com/thumbnail?id=${match[1]}&sz=w600`;
                }
            }
            
            return `<img src="${imgUrl}" alt="${type}" onerror="this.parentElement.innerHTML='<div class=\\'photo-placeholder\\'>Errore caricamento</div>'">`;
        }

        function formatColors(colors) {
            if (!colors) return null;
            if (Array.isArray(colors)) return colors.join(', ');
            return colors;
        }

        function formatGender(gender) {
            const map = { 'M': 'Uomo', 'F': 'Donna', 'U': 'Unisex' };
            return map[gender] || gender;
        }

        // ============================================
        // ACTION BUTTONS
        // ============================================
        function toggleAction(action, silent = false) {
            const btnMap = {
                'tagged': 'btn-tagged',
                'tocheck': 'btn-tocheck',
                'discard': 'btn-discard'
            };

            // Deselect all
            Object.values(btnMap).forEach(id => {
                const el = document.getElementById(id);
                if (el) el.classList.remove('active');
            });

            if (currentAction === action) {
                currentAction = null;
            } else {
                currentAction = action;
                const btn = document.getElementById(btnMap[action]);
                if (btn) btn.classList.add('active');
            }

            hasChanges = true;
            document.getElementById('btn-save').disabled = false;

            if (!silent && currentAction) {
                const msgs = {
                    'tagged': 'Label inserita ‚úì',
                    'tocheck': 'Segnato da rivedere',
                    'discard': 'Articolo da scartare'
                };
                showToast(msgs[currentAction], currentAction === 'tagged' ? 'success' : currentAction === 'discard' ? 'error' : 'warning');
            }
        }

        // ============================================
        // EDIT MODE
        // ============================================
        function toggleEditMode() {
            editMode = !editMode;
            document.getElementById('info-readonly').style.display = editMode ? 'none' : 'block';
            document.getElementById('info-editable').style.display = editMode ? 'block' : 'none';
            
            if (editMode) {
                hasChanges = true;
                document.getElementById('btn-save').disabled = false;
            }
        }

        // ============================================
        // SAVE CHANGES
        // ============================================
        async function saveChanges() {
            if (!currentRecord) return;
            
            const btn = document.getElementById('btn-save');
            btn.disabled = true;
            btn.textContent = 'Salvataggio...';

            try {
                const updateFields = {};
                
                // Set checkbox fields based on action
                if (currentAction === 'tagged') {
                    updateFields['Tagged_Checkbox'] = true;
                    updateFields['To_Check'] = false;
                } else if (currentAction === 'tocheck') {
                    updateFields['To_Check'] = true;
                    updateFields['Tagged_Checkbox'] = false;
                } else if (currentAction === 'discard') {
                    updateFields['Product_Status'] = 'DISCARDED';
                    updateFields['Tagged_Checkbox'] = false;
                    updateFields['To_Check'] = false;
                }

                // Get editable field values if in edit mode
                if (editMode) {
                    const category = document.getElementById('edit-category').value.trim();
                    const subcategory = document.getElementById('edit-subcategory').value.trim();
                    const brand = document.getElementById('edit-brand').value.trim();
                    const color = document.getElementById('edit-color').value.trim();
                    const size = document.getElementById('edit-size').value.trim();
                    const gender = document.getElementById('edit-gender').value;
                    const condition = document.getElementById('edit-condition').value;

                    if (category) updateFields['Category'] = category;
                    if (subcategory) updateFields['Sub-Category'] = subcategory;
                    if (brand) updateFields['Brand_TXT'] = brand;
                    if (color) updateFields['Colors'] = color;
                    if (size) updateFields['Size (INT)'] = size;
                    if (gender) updateFields['gender'] = gender;
                    if (condition) updateFields['Condizione'] = condition;
                }

                // Add notes
                const notes = document.getElementById('notes-input').value.trim();
                if (notes) {
                    updateFields['Note Prodotto'] = notes;
                }

                console.log('Saving fields:', updateFields);

                // Update Airtable
                const url = `https://api.airtable.com/v0/${BASE_ID}/${INVENTARIO_TABLE}/${currentRecord.id}`;
                const response = await fetch(url, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${API_KEY}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ fields: updateFields })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || `API Error: ${response.status}`);
                }

                showToast(`${currentRecord.fields.SKU} salvato ‚úì`, 'success');
                
                hasChanges = false;
                btn.textContent = 'üíæ Salva Modifiche';
                
                // Reload counters
                loadCounters();
                
                // Clear for next search
                clearSearch();

            } catch (error) {
                console.error('Save error:', error);
                showToast(`Errore: ${error.message}`, 'error');
                btn.disabled = false;
                btn.textContent = 'üíæ Salva Modifiche';
            }
        }

        // ============================================
        // CLEAR SEARCH
        // ============================================
        function clearSearch() {
            currentRecord = null;
            currentAction = null;
            hasChanges = false;
            editMode = false;
            
            document.getElementById('sku-search').value = '';
            document.getElementById('sku-display').style.display = 'none';
            document.getElementById('btn-save').disabled = true;
            document.getElementById('btn-save').textContent = 'üíæ Salva Modifiche';
            document.getElementById('notes-input').value = '';
            document.getElementById('info-readonly').style.display = 'block';
            document.getElementById('info-editable').style.display = 'none';
            
            showEmptyState();
            document.getElementById('sku-search').focus();
        }

        // ============================================
        // MODAL
        // ============================================
        function openModalPhoto(type) {
            if (!currentRecord) return;
            const fields = currentRecord.fields;
            
            let url = type === 'front' 
                ? (fields.AI_Front_Image_Link || fields.rawID_FRONT)
                : (fields.AI_Back_Image_Link || fields.rawID_BACK);
            
            if (!url) return;
            
            // Convert to large thumbnail
            if (!url.startsWith('http')) {
                url = `https://drive.google.com/thumbnail?id=${url}&sz=w1200`;
            } else {
                const match = url.match(/\/d\/([^\/]+)/);
                if (match) {
                    url = `https://drive.google.com/thumbnail?id=${match[1]}&sz=w1200`;
                }
            }
            
            document.getElementById('modal-img').src = url;
            document.getElementById('modal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('modal').classList.remove('active');
        }

        // ============================================
        // SETTINGS
        // ============================================
        function openSettings() {
            const hasKey = !!localStorage.getItem('dirtytag_api_key_v3');
            if (confirm(`API Key: ${hasKey ? 'Configurata ‚úì' : 'Non configurata'}\n\nVuoi cancellare i dati salvati e rifare login?`)) {
                localStorage.removeItem('dirtytag_api_key_v3');
                location.reload();
            }
        }

        // ============================================
        // KEYBOARD SHORTCUTS
        // ============================================
        document.addEventListener('keydown', (e) => {
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') {
                return;
            }
            
            switch(e.key.toLowerCase()) {
                case 'escape':
                    closeModal();
                    break;
                case 't':
                    if (currentRecord) toggleAction('tagged');
                    break;
                case 'c':
                    if (currentRecord) toggleAction('tocheck');
                    break;
                case 'x':
                    if (currentRecord) toggleAction('discard');
                    break;
                case 's':
                    if (currentRecord && hasChanges) saveChanges();
                    break;
                case 'e':
                    if (currentRecord) toggleEditMode();
                    break;
                case '/':
                    e.preventDefault();
                    document.getElementById('sku-search').focus();
                    break;
            }
        });
    </script>
</body>
</html>
